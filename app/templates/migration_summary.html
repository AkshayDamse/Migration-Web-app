{% extends "layout.html" %}

{% block content %}
  <div class="page-card">
    <h2>Migration Summary</h2>
    
    {% if authenticated %}
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        Destination authenticated successfully!
      </div>
    {% endif %}
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin: 2rem 0;">
      <!-- Source Details -->
      <div>
        <h3 style="color: #2563eb; border-bottom: 2px solid #2563eb; padding-bottom: 0.5rem;">
          <i class="fas fa-upload"></i> Source (ESXi)
        </h3>
        <div style="margin-top: 1rem;">
          <p><strong>VMs to Migrate:</strong></p>
          <ul>
            {% for vm in source_vms %}
              <li>{{ vm.name }} (UUID: {{ vm.instance_uuid }})</li>
            {% endfor %}
          </ul>
        </div>
      </div>
      
      <!-- Destination Details -->
      <div>
        <h3 style="color: #16a34a; border-bottom: 2px solid #16a34a; padding-bottom: 0.5rem;">
          <i class="fas fa-download"></i> Destination (Proxmox)
        </h3>
        <div style="margin-top: 1rem;">
          <p><strong>Host:</strong> {{ destination_host }}</p>
          <p style="color: #16a34a; font-weight: bold; margin-top: 0.5rem;">
            <i class="fas fa-check-circle"></i> Connected
          </p>
        </div>
      </div>
    </div>
    
    <div class="form-actions" style="margin-top: 2rem;">
      <button type="button" class="btn-primary" onclick="startMigration()" id="start-btn">
        <i class="fas fa-play"></i> Start Migration
      </button>
      <a href="{{ url_for('main.destination_details') }}" class="link-btn">Back</a>
    </div>

    <div class="page-card" style="margin-top: 1rem;">
      <h3>Live Migration Logs</h3>
      <div id="migration-logs" style="white-space: pre-wrap; background:#111; color:#0f0; padding:1rem; height:300px; overflow:auto; font-family: monospace; font-size:12px; border-radius:4px;"></div>
    </div>
  </div>

  <script>
    let currentJob = null;
    async function startMigration() {
      const btn = document.getElementById('start-btn');
      const logsEl = document.getElementById('migration-logs');
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starting...';

      try {
        const resp = await fetch('{{ url_for("main.start_remote_migration_route") }}', { method: 'POST' });
        const json = await resp.json();
        if (!json.success) {
          alert('Failed to start migration: ' + (json.message || 'unknown'));
          btn.disabled = false;
          btn.innerHTML = '<i class="fas fa-play"></i> Start Migration';
          return;
        }

        currentJob = json.job_id;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';

        // Poll logs
        const poll = setInterval(async () => {
          const s = await fetch('{{ url_for("main.migration_status", job_id="") }}' + currentJob);
          const j = await s.json();
          if (!j.success) {
            logsEl.textContent += '\nERROR: ' + (j.message || 'unknown');
            clearInterval(poll);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-play"></i> Start Migration';
            return;
          }

          const job = j.job;
          logsEl.textContent = job.logs.join('\n');
          logsEl.scrollTop = logsEl.scrollHeight;

          if (job.status === 'finished' || job.status === 'failed') {
            clearInterval(poll);
            btn.disabled = false;
            btn.innerHTML = job.status === 'finished' ? '<i class="fas fa-check"></i> Done' : '<i class="fas fa-exclamation-triangle"></i> Failed';
          }
        }, 1500);

      } catch (err) {
        alert('Error starting migration: ' + err.message);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play"></i> Start Migration';
      }
    }
  </script>
{% endblock %}
