{% extends "layout.html" %}

{% block content %}
  <div class="page-card">
    <h2>VMs on {{ host }}</h2>
    {% if authenticated %}
      <div class="alert alert-success">
        <i class="fas fa-check-circle"></i>
        Authenticated to {{ host }} â€” listing VMs below.
      </div>
    {% endif %}
    <form action="{{ url_for('main.start_migration') }}" method="post" id="vm-select-form">
      <table>
        <thead>
          <tr>
            <th>Select</th>
            <th>Sr. No.</th>
            <th>Name</th>
            <th>Instance UUID</th>
          </tr>
        </thead>
        <tbody>
          {% for vm in vms %}
            <tr>
              <td style="text-align: center;">
                <input type="radio" name="selected_vm" value="{{ loop.index }}" id="vm_{{ loop.index }}" class="vm-radio" {% if selected_serials and (loop.index in selected_serials) %}checked{% endif %}>
              </td>
              <td>{{ loop.index }}</td>
              <td>{{ vm.name }}</td>
              <td>{{ vm.instance_uuid }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="form-actions" style="margin-top:1.5rem;">
        <button type="submit" class="btn-primary">Start Migration</button>
        <a href="{{ url_for('main.index') }}" class="link-btn">Back</a>
      </div>
    </form>
  </div>

  <!-- No checkboxes, so no JS needed -->
   <script>
    // When a radio is changed, update config.json via AJAX
    document.querySelectorAll('.vm-radio').forEach(function(radio){
      radio.addEventListener('change', async function(e){
        const serial = e.target.value;
        try {
          const resp = await fetch("{{ url_for('main.select_vm') }}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ serial: serial })
          });
          if (!resp.ok) {
            const json = await resp.json().catch(()=>({message:'Request failed'}));
            alert('Failed to save selection: ' + (json.message || resp.statusText));
          }
        } catch (err) {
          console.error('Error updating selected VM:', err);
          alert('Could not update selected VM: ' + err.message);
        }
      });
    });
  </script>
{% endblock %}
